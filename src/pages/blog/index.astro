---
import Layout from "../../layouts/Layout.astro";
import CTAWhatsApp from "../../components/CTAWhatsApp.astro";
import { supabase } from "../../lib/supabase";

export const prerender = false;

// Force refresh
Astro.response.headers.set(
    "Cache-Control",
    "no-cache, no-store, must-revalidate",
);

const { data: posts, error } = await supabase
    .from("blog_posts")
    .select("*")
    .eq("is_published", true)
    .order("created_at", { ascending: false });

if (error) {
    console.error("Error fetching blog posts:", error);
}
---

<Layout
    title="Blog | Angeles Nails Studio - Consejos de Belleza y Tendencias"
    description="Descubre los mejores consejos de belleza, tendencias en uñas, cuidado de cejas y pestañas en nuestro blog."
>
    <CTAWhatsApp />

    <!-- Hero Section -->
    <section
        class="relative h-[50vh] flex items-center justify-center overflow-hidden pt-32"
    >
        <div class="absolute inset-0 z-0">
            <img
                src="/img/placeholder.svg"
                alt="Blog Angeles Nails"
                class="w-full h-full object-cover"
                id="hero-image"
            />
            <div
                class="absolute inset-0 bg-gradient-to-b from-brown-900/70 via-brown-800/50 to-cream-50"
            >
            </div>
        </div>
        <div class="text-center z-10 px-4 max-w-4xl mx-auto">
            <h1
                class="font-serif text-5xl md:text-7xl font-bold mb-6 text-cream-50 reveal-text opacity-0"
            >
                Nuestro Blog
            </h1>
            <p
                class="text-xl md:text-2xl font-light text-cream-100 mb-8 reveal-text opacity-0"
            >
                Tendencias, consejos y secretos de belleza
            </p>
        </div>
    </section>

    <!-- Blog Grid -->
    <section class="py-24 bg-cream-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-12">
                {
                    posts && posts.length > 0 ? (
                        posts.map((post, index) => (
                            <article
                                class="group cursor-pointer reveal-element opacity-0"
                                style={`transition-delay: ${index * 0.1}s;`}
                            >
                                <div class="overflow-hidden rounded-lg shadow-lg mb-6 h-64 relative bg-gray-200">
                                    <img
                                        src={
                                            post.image_url ||
                                            "/img/placeholder.svg"
                                        }
                                        alt={post.title}
                                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                                    />
                                    <div class="absolute inset-0 bg-black/10 group-hover:bg-transparent transition-colors" />
                                </div>
                                <div class="space-y-4">
                                    <span class="text-gold-600 font-medium text-sm tracking-widest uppercase">
                                        {post.category || "General"}
                                    </span>
                                    <h3 class="text-2xl font-serif font-bold text-brown-800 group-hover:text-gold-600 transition-colors">
                                        <a
                                            href={`/blog/${post.slug}`}
                                            class="block"
                                        >
                                            {post.title}
                                        </a>
                                    </h3>
                                    <p class="text-brown-600 line-clamp-3">
                                        {post.excerpt}
                                    </p>
                                    <a
                                        href={`/blog/${post.slug}`}
                                        class="inline-block text-brown-800 font-medium border-b border-brown-800 pb-1 group-hover:text-gold-600 group-hover:border-gold-600 transition-all"
                                    >
                                        Leer más
                                    </a>
                                </div>
                            </article>
                        ))
                    ) : (
                        <div class="col-span-full text-center py-20">
                            <p class="text-xl text-brown-600">
                                No hay artículos publicados de momento.
                            </p>
                        </div>
                    )
                }
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script>
        import { gsap } from "gsap";
        import { ScrollTrigger } from "gsap/ScrollTrigger";

        gsap.registerPlugin(ScrollTrigger);

        // Hero Animation
        gsap.to("#hero-image", {
            scale: 1.1,
            scrollTrigger: {
                trigger: "body",
                start: "top top",
                end: "bottom top",
                scrub: 1,
            },
        });

        // Reveal Text
        gsap.utils.toArray(".reveal-text").forEach((element: any) => {
            gsap.to(element, {
                opacity: 1,
                y: 0,
                duration: 1,
                ease: "power3.out",
                scrollTrigger: {
                    trigger: element,
                    start: "top 85%",
                },
            });
        });

        // Reveal Elements (Articles)
        gsap.utils.toArray(".reveal-element").forEach((element: any) => {
            gsap.to(element, {
                opacity: 1,
                y: 0,
                duration: 1,
                ease: "power3.out",
                scrollTrigger: {
                    trigger: element,
                    start: "top 85%",
                },
            });
        });
    </script>

    <style>
        .reveal-text,
        .reveal-element {
            transform: translateY(30px);
        }
    </style>
</Layout>
