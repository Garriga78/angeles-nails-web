---
import Layout from "../../layouts/Layout.astro";
import CTAWhatsApp from "../../components/CTAWhatsApp.astro";
import Testimonials from "../../components/Testimonials.astro";
import { supabase } from "../../lib/supabase";

// Force no-cache for Vercel SSR to ensure real-time updates
Astro.response.headers.set(
    "Cache-Control",
    "no-cache, no-store, must-revalidate",
);
Astro.response.headers.set("Pragma", "no-cache");
Astro.response.headers.set("Expires", "0");

// Fetch services from Supabase
const { data: services, error } = await supabase
    .from("services")
    .select("*")
    .eq("category", "peluqueria")
    .order("display_order", { ascending: true });

if (error) {
    console.error("Error loading peluqueria services:", error);
}

// Get first service image for SEO
const seoImage = services?.[0]?.hero_image_url;
---

<Layout
    title="Peluquería en Murcia | Corte y Tratamientos - Angeles Nails Studio"
    description="Salón de peluquería en Murcia. Cortes de tendencia, tratamientos reparadores y estilismo para un cabello sano y radiante."
    image={seoImage}
>
    <CTAWhatsApp message="Hola, quiero reservar una cita de peluquería" />

    <!-- Hero Section -->
    <section
        class="relative h-[70vh] flex items-center justify-center overflow-hidden pt-32"
    >
        <div class="absolute inset-0 z-0">
            <img
                src="/img/placeholder.svg"
                alt="Peluquería en Murcia"
                class="w-full h-full object-cover"
            />
            <div
                class="absolute inset-0 bg-gradient-to-b from-brown-900/70 via-brown-800/50 to-cream-100"
            >
            </div>
        </div>
        <div class="text-center z-10 px-4 max-w-4xl mx-auto">
            <h1
                class="font-serif text-5xl md:text-7xl font-bold mb-6 text-cream-50"
            >
                <span class="hero-word inline-block opacity-0">Cabello</span><br
                />
                <span class="text-gold-400 hero-word inline-block opacity-0"
                    >radiante</span
                >
            </h1>
            <p
                class="text-xl md:text-2xl font-light text-cream-100 mb-8 hero-subtitle opacity-0"
            >
                Salud y brillo en cada mechón
            </p>
        </div>
    </section>

    <!-- Introducción -->
    <section class="py-16 bg-cream-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <p
                class="text-xl text-brown-700 font-light leading-relaxed mb-6 reveal-text opacity-0"
            >
                Tu cabello es tu mejor accesorio. En <strong
                    >Angeles Nails Studio</strong
                >, nos enfocamos en la
                <strong>salud capilar</strong>. Ofrecemos tratamientos profundos
                de recuperación, alisados orgánicos y peinados que te harán
                sentir segura y hermosa.
            </p>
        </div>
    </section>

    <!-- Servicios Listado Elegante -->
    <section class="py-24 bg-cream-100 relative">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2
                class="text-4xl md:text-5xl font-serif font-bold text-center mb-4 reveal-text opacity-0 text-brown-800"
            >
                Nuestros servicios de peluquería
            </h2>
            <p
                class="text-xl text-brown-600 text-center mb-16 max-w-3xl mx-auto reveal-text opacity-0"
            >
                Salud capilar y estilo personalizado
            </p>

            <!-- Floating Preview Card -->
            <div
                id="service-preview"
                class="fixed pointer-events-none z-50 opacity-0"
            >
                <div
                    class="bg-white rounded-lg shadow-2xl overflow-hidden border-2 border-gold-300 w-48 md:w-80"
                >
                    <img
                        id="preview-image"
                        src=""
                        alt=""
                        class="w-full h-48 object-cover"
                    />
                </div>
            </div>

            <!-- Services List -->
            <div class="space-y-0">
                {
                    services && services.length > 0 ? (
                        services.map((service) => (
                            <div
                                class="service-list-item border-b border-gold-200/30 py-6 md:py-8 cursor-pointer group transition-all duration-300 hover:bg-cream-50/50 relative"
                                data-image={
                                    service.hero_image_url ||
                                    "/img/placeholder.svg"
                                }
                            >
                                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 md:gap-12">
                                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-8 flex-1">
                                        <h3 class="text-2xl md:text-5xl font-serif font-light text-brown-800 group-hover:text-gold-600 transition-colors duration-300">
                                            <a
                                                href={`/peluqueria/${service.slug}`}
                                                class="block w-full h-full before:absolute before:inset-0"
                                            >
                                                {service.hero_title}
                                            </a>
                                        </h3>
                                        <p class="text-brown-600 text-sm md:text-base opacity-80 md:opacity-0 group-hover:opacity-100 transition-opacity duration-300 line-clamp-2 md:line-clamp-none max-w-xl">
                                            {service.intro_description ||
                                                service.hero_subtitle}
                                        </p>
                                    </div>
                                    <div class="mt-2 md:mt-0">
                                        <a
                                            href={`https://wa.me/34613302914?text=Hola,%20quiero%20reservar%20${service.hero_title}`}
                                            class="inline-block opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-brown-700 text-cream-50 px-6 py-2 rounded-full hover:bg-gold-500 text-sm font-medium relative z-10"
                                        >
                                            Reservar
                                        </a>
                                    </div>
                                </div>
                            </div>
                        ))
                    ) : (
                        <p class="text-center text-brown-600">
                            No hay servicios disponibles en este momento.
                        </p>
                    )
                }
            </div>
        </div>
    </section>

    <Testimonials />

    <!-- Scripts -->
    <script>
        import { gsap } from "gsap";
        import { ScrollTrigger } from "gsap/ScrollTrigger";

        gsap.registerPlugin(ScrollTrigger);

        // Hero Animations
        const heroWords = document.querySelectorAll(".hero-word");
        heroWords.forEach((word, i) => {
            gsap.to(word, {
                opacity: 1,
                y: 0,
                duration: 0.8,
                ease: "power3.out",
                delay: 0.3 + i * 0.2,
            });
        });

        gsap.to(".hero-subtitle", {
            opacity: 1,
            y: 0,
            duration: 1,
            ease: "power3.out",
            delay: 1,
        });

        // Reveal Texts & Elements
        gsap.utils
            .toArray(".reveal-text, .reveal-element")
            .forEach((element: any) => {
                gsap.to(element, {
                    opacity: 1,
                    y: 0,
                    duration: 1.2,
                    ease: "power3.out",
                    scrollTrigger: {
                        trigger: element,
                        start: "top 85%",
                    },
                });
            });

        // Floating Service Preview
        const preview = document.getElementById("service-preview");
        const previewImage = document.getElementById(
            "preview-image",
        ) as HTMLImageElement;
        const serviceItems = document.querySelectorAll(".service-list-item");

        let leftTo: any;
        let topTo: any;

        if (preview) {
            leftTo = gsap.quickTo(preview, "left", {
                duration: 0.6,
                ease: "power3.out",
            });
            topTo = gsap.quickTo(preview, "top", {
                duration: 0.6,
                ease: "power3.out",
            });
        }

        serviceItems.forEach((item) => {
            const element = item as HTMLElement;
            element.addEventListener("mouseenter", () => {
                const image = element.getAttribute("data-image");
                if (previewImage && preview) {
                    previewImage.src = image || "";
                    gsap.to(preview, {
                        opacity: 1,
                        duration: 0.3,
                    });
                }
            });

            element.addEventListener("mousemove", (e: MouseEvent) => {
                if (preview && leftTo && topTo) {
                    const previewEl = preview.querySelector("div");
                    const previewHeight = previewEl
                        ? previewEl.offsetHeight
                        : 200;
                    const gap = 20;

                    // Smart Vertical Positioning
                    let targetY = e.clientY + gap;
                    if (e.clientY > window.innerHeight / 2) {
                        targetY = e.clientY - previewHeight - gap;
                    }

                    // Horizontal Positioning
                    const targetX = e.clientX + 40;

                    leftTo(targetX);
                    topTo(targetY);
                }
            });

            element.addEventListener("mouseleave", () => {
                if (preview) {
                    gsap.to(preview, {
                        opacity: 0,
                        duration: 0.3,
                    });
                }
            });
        });
    </script>

    <style>
        .hero-word,
        .hero-subtitle,
        .reveal-text {
            transform: translateY(20px);
        }
        .service-list-item {
            transition: all 0.3s ease;
        }
    </style>
</Layout>
<!-- DEBUG TIMESTAMP: {new Date().toISOString()} -->
